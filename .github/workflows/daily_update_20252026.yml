name: Daily Update 2025-2026 (Last 48h Window)

on:
  schedule:
    # GitHub Actions cron uses UTC.
    # 09:30 UTC = 04:30 America/New_York during EST (winter).
    # If you want (e.g.) 07:00 AM New York (EST) -> 12:00 UTC.
    - cron: "30 9 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: daily-update-20252026
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      SEASON_LABEL: "20252026"
      TZ: "America/New_York"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f pyproject.toml ]; then
            pip install .
          else
            echo "No requirements.txt or pyproject.toml found. Add one of them."
            exit 1
          fi

      - name: Compute 48h window (NY time)
        id: window
        run: |
          echo "END_DATE=$(date +%F)" >> $GITHUB_OUTPUT
          echo "START_DATE=$(date -d '2 days ago' +%F)" >> $GITHUB_OUTPUT
          echo "Computed window:"
          echo "START_DATE=$(date -d '2 days ago' +%F)"
          echo "END_DATE=$(date +%F)"

      - name: Pull schedule for last 48 hours
        run: |
          python pipelines/01_pull_schedule.py \
            --season_label "${SEASON_LABEL}" \
            --start "${{ steps.window.outputs.START_DATE }}" \
            --end "${{ steps.window.outputs.END_DATE }}"

      - name: Pull/process game data (last 48 hours)
        run: |
          # If your pipeline has a specific script for updating games, use it here.
          # Common pattern:
          python pipelines/02_pull_game_data.py \
            --season_label "${SEASON_LABEL}" \
            --start "${{ steps.window.outputs.START_DATE }}" \
            --end "${{ steps.window.outputs.END_DATE }}"

      - name: Run any downstream build/aggregation (optional)
        run: |
          # If you have a script that rebuilds derived tables used by the app, call it here.
          # If not, you can delete this step.
          if [ -f pipelines/03_build_app_tables.py ]; then
            python pipelines/03_build_app_tables.py --season_label "${SEASON_LABEL}"
          else
            echo "No pipelines/03_build_app_tables.py found. Skipping."
          fi

      - name: Commit and push changes (if any)
        run: |
          set -e

          # Show what changed (helpful for debugging)
          git status --porcelain

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "Daily update: ${SEASON_LABEL} (last 48h window) [skip ci]"
          git push
