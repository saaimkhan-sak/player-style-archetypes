name: Daily Update (2025-26)

on:
  schedule:
    - cron: "15 6 * * *" # 6:15am UTC daily
  workflow_dispatch:
    inputs:
      season_label:
        description: "Season label like 20252026"
        required: false
        default: "20252026"

permissions:
  contents: write

concurrency:
  group: daily-update-${{ github.ref }}
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-24.04

    env:
      DEFAULT_SEASON: "20252026"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip + data folders
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            data/raw/season/20252026/games
            data/raw/season_schedules/20252026
            data/raw/player_landing/20252026
            data/processed
            data/features
          key: raw-20252026-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            raw-20252026-${{ runner.os }}-
            raw-20252026-

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare directories
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data/processed
          mkdir -p data/features
          mkdir -p data/raw/season
          mkdir -p data/raw/season_schedules
          mkdir -p data/raw/player_landing

      - name: Resolve season + date window
        id: season
        shell: bash
        run: |
          set -euo pipefail

          SEASON="${{ github.event.inputs.season_label }}"
          if [ -z "${SEASON}" ]; then
            SEASON="${DEFAULT_SEASON}"
          fi

          START_YEAR="${SEASON:0:4}"
          END_YEAR="${SEASON:4:4}"

          # Default (generic) window if we don't have a hard-coded season
          START="${START_YEAR}-09-01"
          END="${END_YEAR}-06-30"

          # Hard-code 2025-26 key dates (official source)
          if [ "${SEASON}" = "20252026" ]; then
            START="2025-10-03"
            END="2026-04-16"
          fi

          echo "season_label=${SEASON}" >> "$GITHUB_OUTPUT"
          echo "start=${START}" >> "$GITHUB_OUTPUT"
          echo "end=${END}" >> "$GITHUB_OUTPUT"

          echo "Using season=${SEASON}, start=${START}, end=${END}"

      - name: Pull schedule (creates processed schedule parquet)
        shell: bash
        run: |
          set -euo pipefail
          SEASON="${{ steps.season.outputs.season_label }}"
          START="${{ steps.season.outputs.start }}"
          END="${{ steps.season.outputs.end }}"

          python pipelines/01_pull_schedule.py \
            --season_label "${SEASON}" \
            --start "${START}" \
            --end "${END}"

          ls -la data/processed || true

      - name: Reconcile schedule (optional but recommended)
        shell: bash
        run: |
          set -euo pipefail
          SEASON="${{ steps.season.outputs.season_label }}"
          python pipelines/00_reconcile_season_schedule.py --season_label "${SEASON}" || true

      - name: Pull game data + build features + update outputs
        shell: bash
        run: |
          set -euo pipefail

          SEASON="${{ steps.season.outputs.season_label }}"
          START="${{ steps.season.outputs.start }}"
          END="${{ steps.season.outputs.end }}"

          SCHEDULE_PARQUET="data/processed/schedule_${SEASON}_${START}_${END}.parquet"

          if [ ! -f "${SCHEDULE_PARQUET}" ]; then
            echo "ERROR: schedule parquet not found: ${SCHEDULE_PARQUET}"
            echo "Available schedules in data/processed:"
            ls -ლა data/processed || true
            exit 1
          fi

          python pipelines/02_pull_game_data.py \
            --season_label "${SEASON}" \
            --schedule_parquet "${SCHEDULE_PARQUET}"

          python pipelines/03_build_player_season_features_boxscore.py --season_label "${SEASON}"
          python pipelines/04_build_model_matrices.py --season_label "${SEASON}"
          python pipelines/05_fit_nmf_gmm.py --season_label "${SEASON}"
          python pipelines/06_build_player_directory.py --season_label "${SEASON}"
          python pipelines/06b_enrich_player_names.py --season_label "${SEASON}" || true
          python pipelines/07_make_archetype_cards.py --season_label "${SEASON}"
          python pipelines/08_build_app_tables.py --season_label "${SEASON}"

      - name: Commit & push changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only commit if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "Daily update: ${{ steps.season.outputs.season_label }} ($(date -u +'%Y-%m-%d'))"
            git push
          else
            echo "No changes to commit."
          fi
